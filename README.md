# modern-nodejs

DockOne微信分享专用（2016-07-12）《微服务选型之Modern Node.js》

## 摘要

目前Node.js的发展非常快，大家可能还停留在：Node.js性能很好，Node.js里都是回调，写起来很恶心，Node.js只能做前端工具，Node.js是单线程部署会有问题，以及这样的八卦《uber用go替代Node.js重写了地理位置服务》...

可是真相呢？

在微服务盛行的今天，为什么我们要选用Node.js去构建微服务呢？本次分享将试图从以下2个方面给出答案：

- 被误解的Node.js：除了性能，都是病？
- 现代的Node.js：构建微服务利器

## 个人介绍

i5ting（江湖人称狼叔），空弦科技 CTO，StuQ 明星讲师，开源项目 Moajs 作者，Node.js 技术布道者，即将出版《更了不起的 Node 4：将下一代 Web 框架 Koa 进行到底》

曾就职在新浪、网秦，曾做过前端、后端、数据分析、移动端负责人、做过首席架构师、技术总监，全栈技术实践者，目前主要关注技术架构和团队梯队建设方向。

![I5ting](i5ting.jpg)

Mixu说的最经典的一句话：

> Everything runs in parallel except your code!（在Node中）除了代码，一切都是并行的！



# 被误解的Node.js：除了性能，都是病？

- 单线程，会死？
- 异步（callbackhell）太恶心？
- mongodb事务？
- 接入层？
- uber用go替代Node.js重写了地理位置服务？

## 单线程，会死？

### Node.js为什么是单线程呢？

别只看缺点，先知道缺点是为什么来的？Node.js为什么是单线程呢？

node.js中的第一个基本论点是I/O是昂贵的：

![Io Cost](io-cost.png)

当前编程技术中最大的浪费是等待I/O的完成。这里有几种用来处理这个性能影响的方法（来自Sam Rushing）：

- 同步：你同一时间只处理一个请求，每次一个。优点：简单；缺点：任何一个请求都可以挂起所有其他请求。
- fork新进程：你启动一个新进程来处理每个请求。优点：简单；缺点：无法很好的扩展，大量的连接意味着大量的进程。fork()是Unix程序员的锤子。因为它可用，所以每个问题看起来都像一个钉子。但是通常情况下都是大炮打蚊子。
- 线程：启动新的线程来处理每个请求。优点：简单，比使用fork对内核更加友好，因为线程占用更少的系统开销；缺点：你的机器可能没有线程，而且面向线程的编程由于担心对共享资源的访问控制，可能会很快地变得非常复杂。

第二个基本的论点是「每个连接一个线程」的模式是很耗内存的：[比如每个人都展示过的关于Apache与Nginx对比过的内存消耗图]

Apache是多线程的：它的一个请求产生一个线程（或者进程，取决于配置文件）。随着并发连接数的增加以及为了服务更多的并发客户端而对更多线程的需求，你可以看见系统统开销是如何吃掉内存的。Nginx和Node.js不是多线程，因为多个线程和多个进程会需要大量的内存。它们都是单线程的，但是是事件驱动。通过在一个线程中处理多个连接，这消除了由上千个线程/进程所产生的系统消耗。

至此理解Node.js的2大核心：（单线程的）异步事件和（单线程的）非阻塞io

![CPU2](CPU2.png)

其实最大的改变是，强制开发写代码的时候要以异步模式来思考

### 会死？

单线程非常脆弱，随便弄点什么异常都会挂掉。

## 异步（callbackhell）太恶心？

## mongodb事务？

## 接入层？

## uber用go替代Node.js重写了地理位置服务？

## 合理选型

Node.js是单线程的，从上面的说明，我们可以知道Node.js对于io密集型应用开发是非常棒的，其他，如cpu-密集型的就不是那么适合。

那时下最流行的直播来说，Node.js可以做直播么？

肯定是可以的，但全是Node.js效率不会特别高，比较直播音频、视频、图片、编辑码，以及socket不是Node.js最强的点，像很多公司采用go去实现这部分是非常棒的。

- 实时视频（推荐go）
- 其他用Node.js做都非常合适，无论是聊天室，弹幕，还是各种rank，api等


# 现代的Node.js：构建微服务利器

- 小而美
- 同步的Node.js
- 善用npm，实现3化（模块化，最小化，服务化）
- 使用docker compose作为本地开发环境
- 微服务选型

# 联系我

![Sang](sang.jpg)